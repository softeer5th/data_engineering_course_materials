services:
  namenode:
    platform: linux/arm64
    image: hadoop_fully:0.2.5
    container_name: namenode
    hostname: namenode
    ports:
      - "9870:9870"    # namenode webui
      - "8020:8020"    # namenode RPC
      - "8088:8088"    # Resource manager WebUI
      - "8032:8032"    # Resource manager RPC
      - "8090:8090"    # application master WebUI
      - "19888:19888"  # Job history Server WebUI
      - "10020:10020"  # Job history Server RPC
    volumes:
      - ./data/namenode:/home/hadoop/hdfs/namenode
    command: /bin/bash -c "
      sudo chmod 777 /home/hadoop/etc/hadoop/workers &&
      rm -f /home/hadoop/etc/hadoop/workers &&
      touch /home/hadoop/etc/hadoop/workers &&
      echo 'datanode-1' >> /home/hadoop/etc/hadoop/workers && 
      echo 'datanode-2' >> /home/hadoop/etc/hadoop/workers && 
      echo 'datanode-3' >> /home/hadoop/etc/hadoop/workers && 
      sudo service ssh start && 
      /home/hadoop/bin/hdfs namenode -format -force && 
      /home/hadoop/sbin/start-dfs.sh && 
      /home/hadoop/sbin/start-yarn.sh &&
      tail -f /dev/null"

  datanode-1:
    platform: linux/arm64
    image: hadoop_fully:0.2.5
    container_name: datanode-1
    hostname: datanode-1
    environment:
      - HADOOP_HOME=/home/hadoop
    volumes:
      - ./data/datanode-1:/home/hadoop/hdfs/datanode
    command: /bin/bash -c "sudo service ssh start && tail -f /dev/null"

  datanode-2:
    platform: linux/arm64
    image: hadoop_fully:0.2.5
    container_name: datanode-2
    hostname: datanode-2
    volumes:
      - ./data/datanode-2:/home/hadoop/hdfs/datanode
    command: /bin/bash -c "sudo service ssh start && tail -f /dev/null"

  datanode-3:
    platform: linux/arm64
    image: hadoop_fully:0.2.5
    container_name: datanode-3
    hostname: datanode-3
    volumes:
      - ./data/datanode-3:/home/hadoop/hdfs/datanode
    command: /bin/bash -c "sudo service ssh start && tail -f /dev/null"